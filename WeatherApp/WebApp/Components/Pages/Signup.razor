@page "/signup"
@using Blazored.Toast.Configuration
@using Domain.Request.Auth
@using Infrastructure.Clients
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using WebApp.Providers
@inject CustomAuthenticationStateProvider AuthenticationStateProvider
@inject IAuthApiClient Client
@inject NavigationManager Navigation
@inject ProtectedSessionStorage sessionStorage
@inject IToastService toastService
@rendermode InteractiveServer

<BlazoredToasts Position="ToastPosition.BottomRight"
				Timeout="5" />
<div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
	<div class="card" style="width: 100%; max-width: 400px;">
		<div class="card-body">
			<h3 class="card-title text-center">Sign Up</h3>
			<EditForm Model="@signupModel" OnValidSubmit="HandleValidSubmit" FormName="signupForm">

				<div class="form-group mb-3">
					<label for="name">Name</label>
					<InputText id="name" class="form-control" @bind-Value="signupModel.Name" />
					<ValidationMessage For="@(() => signupModel.Name)" />
				</div>

				<div class="form-group mb-3">
					<label for="email">Email</label>
					<InputText id="email" class="form-control" @bind-Value="signupModel.Email" />
					<ValidationMessage For="@(() => signupModel.Email)" />
				</div>

				<div class="form-group mb-3">
					<label for="password">Senha</label>
					<InputText id="password" type="password" class="form-control" @bind-Value="signupModel.Password" />
					<ValidationMessage For="@(() => signupModel.Password)" />
				</div>

				<button type="submit" class="btn btn-primary mt-3">Sign Up</button>
			</EditForm>
		</div>
	</div>
</div>

@code {
	private SignupRequest signupModel = new SignupRequest();
	private async Task HandleValidSubmit()
	{
		try
		{
			var token = await Client.SignupAsync(signupModel);
			await AuthenticationStateProvider.MarkUserAsAuthenticatedAsync(token);
			await sessionStorage.SetAsync("authToken", token);
			Navigation.NavigateTo("/");
		}
		catch
		{
			toastService.ShowError("Usuário não encontrado");
		}
	}
}
